<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RMA 表格生成工具 (網頁版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Microsoft JhengHei', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* 自定義 Tailwind 樣式 */
        .container {
            max-width: 1400px;
            margin: auto;
        }
        .copied-message {
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            z-index: 1000;
        }
        .copied-message.show {
            opacity: 1;
        }
        /* 確保輸出表格的樣式能被郵件軟體識別 */
        .table-output table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        .table-output th, .table-output td {
            border: 1px solid #e5e7eb;
            padding: 10px 12px;
            text-align: left;
        }
        .table-output th {
            background-color: #f3f4f6;
            font-weight: 600;
            white-space: nowrap;
        }
        /* 輸入表格的樣式 */
        .input-table td {
            padding: 8px 10px;
        }
        .input-table input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .plaintext-output {
            white-space: pre;
            font-family: monospace;
            padding: 1rem;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            overflow-x: auto;
            border-radius: 6px;
        }
        /* 寄件表格專用樣式 */
        @media print {
            .shipping-form { page-break-after: always; }
        }
        .shipping-form {
            background-color: #ffffff;
            border: 2px solid #ccc;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .shipping-form h4 {
            border-bottom: 2px solid #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-50 p-4 sm:p-8 font-sans">
    <div id="app" class="container bg-white shadow-2xl rounded-xl p-6 md:p-10">
        
        <h1 class="text-3xl font-bold text-gray-800 mb-2">RMA 換貨/維修表格生成工具</h1>
        <p class="text-gray-600 mb-4">管理多筆 RMA 記錄，並生成郵件 (HTML) 及 Excel (純文字) 表格。</p>

        <!-- Firebase 狀態顯示 -->
        <div id="authStatus" class="mb-6 p-3 bg-indigo-50 border border-indigo-200 rounded-lg text-sm text-indigo-700 flex items-center justify-between">
            <span id="loadingMessage">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                正在載入服務...
            </span>
            <span id="userInfo" class="font-semibold hidden"></span>
        </div>

        <!-- 輸入控制區塊 -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 p-4 rounded-lg bg-yellow-50 border border-yellow-200 gap-4">
            <h2 class="text-xl font-semibold text-gray-700">① 管理 RMA 記錄</h2>
            <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                <button onclick="showPasteModal()" 
                    class="flex items-center justify-center px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md whitespace-nowrap">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1 12 12-12-12z"></path></svg>
                    貼上標準 RMA 文本
                </button>
                <button onclick="showExchangeModal()" 
                    class="flex items-center justify-center px-4 py-2 bg-pink-600 text-white text-sm font-medium rounded-lg hover:bg-pink-700 transition duration-150 shadow-md whitespace-nowrap">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    貼上換貨資訊 (新舊序號/備註)
                </button>
                <button onclick="addItem()" 
                    class="flex items-center justify-center px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition duration-150 shadow-md whitespace-nowrap">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    新增一筆空白資料
                </button>
            </div>
        </div>

        <!-- 資料儲存與歷史記錄控制 -->
        <div id="dataControl" class="flex flex-col sm:flex-row justify-between items-center mb-8 p-4 rounded-lg bg-gray-100 border border-gray-300 gap-4 hidden">
            <button onclick="showHistoryModal()" id="loadBtn"
                class="flex items-center justify-center px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-lg hover:bg-gray-700 transition duration-150 shadow-md whitespace-nowrap">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m15.356 2H20M4 12v5h.582m15.356 2A8.001 8.001 0 004.582 9m15.356 2H20"></path></svg>
                載入歷史 RMA 批次
            </button>
            <div class="flex gap-2 items-center w-full sm:w-auto">
                <input type="text" id="batchNameInput" placeholder="輸入批次名稱 (例如: 10月31日批次)" class="p-2 border rounded-lg flex-grow">
                <button onclick="saveCurrentBatch()" id="saveBtn"
                    class="flex items-center justify-center px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition duration-150 shadow-md whitespace-nowrap">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-3 0V4a2 2 0 00-2-2H9a2 2 0 00-2 2v3m7 0h-3"></path></svg>
                    儲存當前批次
                </button>
            </div>
        </div>


        <!-- RMA 列表輸入區 -->
        <div id="rmaListContainer" class="mb-10 overflow-x-auto shadow-lg rounded-lg border">
            <!-- Dynamic RMA items will be rendered here -->
            <div class="p-6 text-center text-gray-500 italic" id="emptyListMessage">
                目前沒有 RMA 記錄，請點擊上方按鈕新增資料。
            </div>
        </div>


        <!-- 輸出區塊 -->
        <div id="outputSection" class="border-t pt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">② 生成結果 (<span id="itemCount">0</span> 筆記錄)</h2>

            <!-- HTML Table 輸出 (用於郵件) -->
            <div class="mb-8 p-4 border rounded-lg bg-white shadow-md">
                <h3 class="text-xl font-semibold text-gray-700 mb-4 flex justify-between items-center">
                    A. HTML 表格 (用於郵件)
                    <button onclick="copyTableContent('html')" id="copyHtmlBtn"
                        class="flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-2m-6-13l-4 4m0 0l4 4m-4-4h12"></path></svg>
                        複製 HTML 表格
                    </button>
                </h3>
                <div id="htmlTableOutput" class="overflow-x-auto table-output">
                    <p class="text-gray-500 italic">請新增 RMA 記錄以生成表格。</p>
                </div>
            </div>

            <!-- Plaintext Table 輸出 (用於 Excel 貼上) -->
            <div class="mb-8 p-4 border rounded-lg bg-white shadow-md">
                <h3 class="text-xl font-semibold text-gray-700 mb-4 flex justify-between items-center">
                    B. 純文字表格 (用於 Excel/試算表貼上)
                    <button onclick="copyTableContent('plaintext')" id="copyPlaintextBtn"
                        class="flex items-center px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 transition duration-150 shadow-md">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-2m-6-13l-4 4m0 0l4 4m-4-4h12"></path></svg>
                        複製純文字表格
                    </button>
                </h3>
                <pre id="plaintextTableOutput" class="plaintext-output">
請新增 RMA 記錄以生成表格。
                </pre>
            </div>
            
            <!-- Output Section C (Shipping Forms) -->
            <div class="mb-8 p-4 border rounded-lg bg-white shadow-md">
                <h3 class="text-xl font-semibold text-gray-700 mb-4 flex justify-between items-center">
                    C. 寄件用表格 (列印 / Word 匯出用)
                    <div class="flex gap-2">
                        <button onclick="printShippingForms()" id="printShippingBtn"
                            class="flex items-center px-4 py-2 bg-yellow-600 text-white text-sm font-medium rounded-lg hover:bg-yellow-700 transition duration-150 shadow-md">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m0 0v-4m0 4h2m4 0h2m4 0h2m-4 0v-4m-4 4h2m4 0h2m-4 0v-4"></path></svg>
                            列印所有表格
                        </button>
                        <button onclick="copyShippingForms()" id="copyShippingBtn"
                            class="flex items-center px-4 py-2 bg-orange-600 text-white text-sm font-medium rounded-lg hover:bg-orange-700 transition duration-150 shadow-md">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-2m-6-13l-4 4m0 0l4 4m-4-4h12"></path></svg>
                            複製所有表格 (Word)
                        </button>
                    </div>
                </h3>
                <div id="shippingFormsOutput" class="overflow-x-auto">
                    <p class="text-gray-500 italic">請新增 RMA 記錄以生成寄件表格。</p>
                </div>
            </div>

        </div>

        <!-- 貼上標準 RMA 文本 Modal -->
        <div id="pasteModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
                <h3 class="text-2xl font-bold mb-4 text-indigo-700">貼上標準 RMA 資訊文本 (單筆)</h3>
                <textarea id="modalRmaInput" rows="8"
                    class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 placeholder-gray-400 mb-4"
                    placeholder="例如：
RMA Number: R200591359
Defective Serial Number: TU8SA68128
Defective Product ID: ACX710DC
..."></textarea>
                <div class="flex justify-end gap-3">
                    <button onclick="hidePasteModal()" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400 transition">
                        取消
                    </button>
                    <button onclick="extractAndAddItem('standard')" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        解析並新增記錄
                    </button>
                </div>
            </div>
        </div>

        <!-- 貼上換貨資訊 Modal -->
        <div id="exchangeModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
                <h3 class="text-2xl font-bold mb-4 text-pink-700">貼上換貨資訊 (新舊序號/備註)</h3>
                <textarea id="modalExchangeInput" rows="8"
                    class="w-full p-3 border border-pink-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 text-gray-700 placeholder-gray-400 mb-4"
                    placeholder="請貼上類似以下格式的內容：

TCC84056000-ACX710-01 (Reference ID)
舊序號: TU8SA79237 或 old: TU8SA79237
新序號: TU8SB95388 或 new: TU8SB95388
備註：TCC84056000-ACX710-01 PEM 0 Feed B Not OK
"></textarea>
                <div class="flex justify-end gap-3">
                    <button onclick="hideExchangeModal()" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400 transition">
                        取消
                    </button>
                    <button onclick="extractAndAddItem('exchange')" class="px-4 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition">
                        解析並新增記錄
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 歷史記錄 Modal -->
        <div id="historyModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
                <h3 class="text-2xl font-bold mb-4 text-gray-700">歷史 RMA 批次記錄</h3>
                <div id="historyList" class="space-y-3">
                    <p class="text-gray-500 italic">正在載入歷史記錄...</p>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button onclick="hideHistoryModal()" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400 transition">
                        關閉
                    </button>
                </div>
            </div>
        </div>

        <!-- 批次詳情 Modal -->
        <div id="batchDetailModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <h3 class="text-2xl font-bold mb-4 text-gray-700">批次詳情: <span id="detailBatchName" class="text-indigo-600"></span></h3>
                <div id="detailBatchContent" class="mb-4 overflow-x-auto table-output">
                    <p class="text-gray-500 italic">載入中...</p>
                </div>
                <div class="flex justify-between items-center mt-6 border-t pt-4">
                    <button onclick="loadBatchToEditor()" id="detailLoadBtn"
                        class="flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        載入至編輯區 (將覆蓋當前資料)
                    </button>
                    <button onclick="hideBatchDetailModal()" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400 transition">
                        關閉
                    </button>
                </div>
            </div>
        </div>

        <!-- 複製成功提示 -->
        <div id="copiedMsg" class="copied-message fixed bottom-4 right-4 bg-gray-800 text-white px-5 py-3 rounded-xl shadow-2xl">
            已成功複製到剪貼簿！
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 全局狀態：儲存所有 RMA 記錄的陣列
        let rmaItems = [];
        let db, auth;
        let userId = 'anonymous'; 
        let isAuthReady = false;
        // 用於在詳情視窗和載入功能之間傳遞選定的歷史批次資料
        let currentDetailBatchRecords = null; 
        
        // Firestore 集合路徑
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const FIRESTORE_COLLECTION_PATH = `/artifacts/${appId}/public/data/rma_batches`;
        
        // 錯誤日誌
        setLogLevel('debug');

        // --- Firebase 初始化與認證 ---
        // 使用者提供的 Firebase 配置 (硬編碼)
        const firebaseConfig = {
            apiKey: "AIzaSyCODkFiLx1kbI9XfHGPPTP2TZ_WgDcBLX0",
            authDomain: "rma-tool-b4b19.firebaseapp.com",
            projectId: "rma-tool-b4b19",
            storageBucket: "rma-tool-b4b19.firebasestorage.app",
            messagingSenderId: "248478901007",
            appId: "1:248478901007:web:a96bfd908ab18a1f4ed47a"
        };

        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                const loadingMsg = document.getElementById('loadingMessage');
                const userInfo = document.getElementById('userInfo');
                const dataControl = document.getElementById('dataControl');

                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    loadingMsg.textContent = '服務已載入。';
                    userInfo.textContent = `使用者 ID: ${userId}`;
                    userInfo.classList.remove('hidden');
                    dataControl.classList.remove('hidden');
                    console.log("Firebase initialized and user authenticated:", userId);
                    loadHistoryListener(); // 監聽歷史記錄
                } else {
                    // 總是嘗試匿名登入 (最穩定的方法)
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        // 修正後的錯誤提示：明確指示檢查匿名登入設定
                        loadingMsg.textContent = `認證失敗，功能受限。請檢查 Firebase Console 中的「Authentication (匿名登入)」設定是否已啟用。錯誤碼: ${error.code || '未知'}`;
                        loadingMsg.classList.add('text-red-700');
                        isAuthReady = true;
                        dataControl.classList.add('hidden'); // 隱藏儲存功能
                    }
                }
            });
        } else {
            console.error("Firebase config is missing.");
            document.getElementById('loadingMessage').textContent = 'Firebase 配置遺失，資料儲存功能無法使用。';
            isAuthReady = true; // 允許應用程式的其他部分運行
        }
        
        // --- MODAL 顯示/隱藏函數 ---
        window.showPasteModal = function() {
            document.getElementById('pasteModal').style.display = 'flex';
            document.getElementById('modalRmaInput').value = ''; 
        }

        window.hidePasteModal = function() {
            document.getElementById('pasteModal').style.display = 'none';
        }

        window.showExchangeModal = function() {
            document.getElementById('exchangeModal').style.display = 'flex';
            document.getElementById('modalExchangeInput').value = ''; 
        }

        window.hideExchangeModal = function() {
            document.getElementById('exchangeModal').style.display = 'none';
        }
        
        window.showHistoryModal = function() {
            document.getElementById('historyModal').style.display = 'flex';
        }

        window.hideHistoryModal = function() {
            document.getElementById('historyModal').style.display = 'none';
        }
        
        window.showBatchDetailModal = function() {
            document.getElementById('batchDetailModal').style.display = 'flex';
        }
        
        window.hideBatchDetailModal = function() {
            document.getElementById('batchDetailModal').style.display = 'none';
            currentDetailBatchRecords = null; // 清空緩存
        }


        // --- 資料庫操作功能 ---

        // 儲存當前的 RMA 批次到 Firestore
        window.saveCurrentBatch = async function() {
            if (!isAuthReady || rmaItems.length === 0) {
                alert('請先登入或新增 RMA 記錄才能儲存。');
                return;
            }

            const batchNameInput = document.getElementById('batchNameInput');
            let batchName = batchNameInput.value.trim() || `RMA 批次 - ${new Date().toLocaleString('zh-TW', { dateStyle: 'short', timeStyle: 'short' })}`;

            if (!batchName) return;

            try {
                const docRef = await addDoc(collection(db, FIRESTORE_COLLECTION_PATH), {
                    userId: userId,
                    name: batchName,
                    timestamp: Date.now(),
                    // 將整個 RMA 陣列序列化為 JSON 字串以便安全儲存
                    records: JSON.stringify(rmaItems), 
                });
                
                // 儲存成功後清空畫面
                rmaItems = []; 
                renderRmaItems(); 

                showCopyMessage(`批次 "${batchName}" (ID: ${docRef.id.substring(0, 4)}...) 儲存成功！`, 'bg-green-600', 'saveBtn');
                batchNameInput.value = ''; // 清空名稱輸入框
            } catch (e) {
                console.error("Error adding document: ", e);
                showCopyMessage("儲存失敗：請檢查網路或權限。", 'bg-red-600', 'saveBtn');
            }
        }

        // 監聽歷史記錄 (只負責載入列表)
        function loadHistoryListener() {
            if (!isAuthReady) return;

            const q = query(collection(db, FIRESTORE_COLLECTION_PATH), orderBy("timestamp", "desc"));
            
            onSnapshot(q, (snapshot) => {
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '';
                
                if (snapshot.empty) {
                    historyList.innerHTML = '<p class="text-gray-500 italic">目前沒有歷史批次記錄。</p>';
                    return;
                }

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const date = new Date(data.timestamp).toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                    // 使用 try-catch 處理 JSON 解析錯誤
                    let recordCount = 0;
                    try {
                         recordCount = JSON.parse(data.records).length;
                    } catch (e) {
                        console.error("Error parsing records count:", e);
                    }


                    const itemHtml = `
                        <div class="flex justify-between items-center p-3 border rounded-lg bg-white shadow-sm hover:bg-gray-50">
                            <div>
                                <p class="font-semibold text-gray-800">${data.name} (<span class="text-xs text-gray-500">${recordCount} 筆記錄</span>)</p>
                                <p class="text-xs text-gray-500">儲存者: ${data.userId.substring(0, 8)}... | 時間: ${date}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="fetchAndShowBatchDetails('${doc.id}')" class="px-3 py-1 bg-indigo-500 text-white text-sm rounded-lg hover:bg-indigo-600 transition whitespace-nowrap">
                                    檢視詳情
                                </button>
                                <button onclick="deleteBatch('${doc.id}', '${data.userId}')" class="px-3 py-1 bg-red-500 text-white text-sm rounded-lg hover:bg-red-600 transition">
                                    刪除
                                </button>
                            </div>
                        </div>
                    `;
                    historyList.innerHTML += itemHtml;
                });
            }, (error) => {
                console.error("Error listening to history:", error);
                document.getElementById('historyList').innerHTML = '<p class="text-red-500 italic">載入歷史記錄失敗。</p>';
            });
        }

        // 獲取並顯示批次詳情 (非破壞性操作)
        window.fetchAndShowBatchDetails = function(docId) {
            // 隱藏歷史清單
            hideHistoryModal(); 
            
            const detailContent = document.getElementById('detailBatchContent');
            detailContent.innerHTML = '<p class="text-gray-500 italic p-4 text-center">載入中...</p>';

            // 這裡使用一個臨時快照讀取，確保我們拿到最新的資料
            const unsubscribe = onSnapshot(doc(db, FIRESTORE_COLLECTION_PATH, docId), (docSnapshot) => {
                unsubscribe(); // 讀取一次後立即停止監聽
                
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    document.getElementById('detailBatchName').textContent = data.name;
                    
                    try {
                        // 解析記錄並儲存到全局變數，以供載入功能使用
                        const records = JSON.parse(data.records);
                        currentDetailBatchRecords = records;
                        
                        // 渲染唯讀表格
                        detailContent.innerHTML = renderBatchDetailTable(records);

                        // 顯示詳情視窗
                        showBatchDetailModal();

                    } catch (e) {
                        console.error("Error parsing records:", e);
                        detailContent.innerHTML = '<p class="text-red-500 italic p-4 text-center">載入失敗：資料格式錯誤。</p>';
                        showBatchDetailModal();
                    }
                } else {
                    detailContent.innerHTML = '<p class="text-red-500 italic p-4 text-center">載入失敗：批次不存在。</p>';
                    showBatchDetailModal();
                }
            });
        }

        // 渲染唯讀批次詳情表格
        function renderBatchDetailTable(items) {
             let bodyHtml = '';
            const thStyle = "border: 1px solid #e5e7eb; padding: 10px 12px; text-align: left; background-color: #f3f4f6; font-weight: 600;";
            const tdStyle = "border: 1px solid #e5e7eb; padding: 10px 12px; text-align: left;";
            const tdSnStyle = "border: 1px solid #e5e7eb; padding: 10px 12px; text-align: left; font-weight: bold; color: #10B981;"; 
            const tdTrackStyle = "border: 1px solid #e5e7eb; padding: 10px 12px; text-align: left; font-weight: bold; color: #3B82F6;"; 

            items.forEach((item, index) => {
                let displayNotes = item.notes.trim() || 'N/A';

                bodyHtml += `
                    <tr>
                        <td style="${tdStyle}">${index + 1}</td>
                        <td style="${tdStyle}">${item.rmaNo || 'N/A'}</td>
                        <td style="${tdStyle}">${item.productID || 'N/A'}</td>
                        <td style="${tdStyle}">${item.defectiveSn || 'N/A'}</td>
                        <td style="${tdSnStyle}">${item.replacementSn || '【待確認】'}</td>
                        <td style="${tdStyle}">${displayNotes}</td>
                        <td style="${tdTrackStyle}">${item.trackingNumber || '【待填寫】'}</td>
                    </tr>
                `;
            });

            const tableStyle = "width: 100%; border-collapse: collapse; font-size: 0.9rem; font-family: 'Inter', 'Microsoft JhengHei', sans-serif;";
            
            return `
                <table style="${tableStyle}">
                    <thead>
                        <tr>
                            <th style="${thStyle}" class="w-10">#</th>
                            <th style="${thStyle}">RMA</th>
                            <th style="${thStyle}">設備型號</th>
                            <th style="${thStyle}">換下序號 (Def. SN)</th>
                            <th style="${thStyle}">換上序號 (Rep. SN)</th>
                            <th style="${thStyle}">備註 (Notes)</th>
                            <th style="${thStyle}">貨運單號</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${bodyHtml.trim()}
                    </tbody>
                </table>
            `;
        }

        // 載入指定的批次記錄到當前編輯器 (點擊詳情視窗中的載入按鈕時觸發)
        window.loadBatchToEditor = function() {
            if (!currentDetailBatchRecords) {
                showCopyMessage('載入失敗：未選擇有效的批次。', 'bg-red-600');
                return;
            }

            const confirmLoad = confirm('確定要載入此批次嗎？這將覆蓋您當前編輯中的所有資料！');
            if (!confirmLoad) return;

            // 賦值並刷新 UI
            rmaItems = currentDetailBatchRecords; 
            renderRmaItems();
            hideBatchDetailModal();
            showCopyMessage(`批次 "${document.getElementById('detailBatchName').textContent}" 載入成功！`, 'bg-indigo-600');
            currentDetailBatchRecords = null; // 清理全局變數
        }
        
        // 刪除指定的批次記錄
        window.deleteBatch = async function(docId, ownerId) {
            if (userId !== ownerId) {
                alert('您只能刪除您自己儲存的批次記錄。');
                return;
            }

            const confirmDelete = confirm('確定要永久刪除這筆歷史記錄嗎？');
            if (!confirmDelete) return;

            try {
                await deleteDoc(doc(db, FIRESTORE_COLLECTION_PATH, docId));
                showCopyMessage('批次記錄已刪除。', 'bg-red-600');
            } catch (e) {
                console.error("Error deleting document: ", e);
                showCopyMessage("刪除失敗：請檢查網路或權限。", 'bg-red-600');
            }
        }

        // --- 資料解析邏輯 (保持不變) ---
        function parseRmaText(input) {
            const data = {};
            if (!input) return data;

            const patterns = [
                { key: 'rmaNo', regex: /RMA Number:\s*(.*)/i },
                { key: 'defectiveSn', regex: /Defective Serial Number:\s*(.*)/i },
                { key: 'productID', regex: /Defective Product ID:\s*(.*)/i },
                { key: 'productDesc', regex: /Defective Product Description:\s*(.*)/i },
            ];
            
            patterns.forEach(({ key, regex }) => {
                const match = input.match(regex);
                if (match && match[1]) {
                    data[key] = match[1].trim();
                }
            });

            return data;
        }

        function parseExchangeText(input) {
            const data = { productID: '', notes: '' }; 
            if (!input) return data;

            const defectiveSnMatch = input.match(/(舊序號|old)\s*[:：]\s*(.*)/i);
            const replacementSnMatch = input.match(/(新序號|new)\s*[:：]\s*(.*)/i);
            const snRegex = /(舊序號|old|新序號|new)\s*[:：]/i;

            data.defectiveSn = defectiveSnMatch ? defectiveSnMatch[2].trim() : '';
            data.replacementSn = replacementSnMatch ? replacementSnMatch[2].trim() : '';

            let notes = [];
            const lines = input.split('\n').map(line => line.trim()).filter(line => line.length > 0);

            let isFirstLine = true;
            lines.forEach(line => {
                if (line.match(snRegex)) {
                    return; 
                }
                
                if (isFirstLine) {
                    const productMatch = line.match(/-(.+?)-\d{2}$/);
                    data.productID = productMatch ? productMatch[1].trim() : '';
                }

                notes.push(line);
                
                isFirstLine = false; 
            });
            
            data.notes = notes.join('\n').trim();
            
            return data;
        }

        // --- 資料處理與新增/合併 (保持不變) ---

        window.extractAndAddItem = function(type) {
            let input, parsedData;

            if (type === 'standard') {
                input = document.getElementById('modalRmaInput').value;
                parsedData = parseRmaText(input);
                hidePasteModal();
            } else if (type === 'exchange') {
                input = document.getElementById('modalExchangeInput').value;
                parsedData = parseExchangeText(input);
                hideExchangeModal();
            } else {
                return;
            }

            if (parsedData.rmaNo || parsedData.defectiveSn || parsedData.replacementSn) {
                let isMerged = false;
                
                if (rmaItems.length > 0) {
                    const lastItem = rmaItems[rmaItems.length - 1];
                    const isLastItemBlank = !lastItem.rmaNo && !lastItem.defectiveSn && !lastItem.replacementSn;
                    
                    if (type === 'exchange' || isLastItemBlank) {
                        lastItem.rmaNo = lastItem.rmaNo || parsedData.rmaNo || '';
                        lastItem.defectiveSn = lastItem.defectiveSn || parsedData.defectiveSn || '';
                        lastItem.replacementSn = lastItem.replacementSn || parsedData.replacementSn || '';
                        lastItem.productID = lastItem.productID || parsedData.productID || '';
                        lastItem.productDesc = lastItem.productDesc || parsedData.productDesc || '';
                        lastItem.notes = lastItem.notes || parsedData.notes || ''; 

                        isMerged = true;
                    }
                }

                if (!isMerged) {
                    const newItem = {
                        id: Date.now() + Math.random(), 
                        rmaNo: parsedData.rmaNo || '',
                        defectiveSn: parsedData.defectiveSn || '',
                        replacementSn: parsedData.replacementSn || '',
                        productID: parsedData.productID || '',
                        productDesc: parsedData.productDesc || '',
                        trackingNumber: '',
                        notes: parsedData.notes || '',
                    };
                    rmaItems.push(newItem);
                }
                
                renderRmaItems();
            } else {
                console.error("無法解析 RMA 資訊。");
            }
        }

        window.addItem = function() {
            const newItem = {
                id: Date.now() + Math.random(), 
                rmaNo: '',
                defectiveSn: '',
                productID: '',
                productDesc: '',
                replacementSn: '',
                trackingNumber: '',
                notes: ''
            };
            rmaItems.push(newItem);
            renderRmaItems();
        }

        window.deleteItem = function(index) {
            rmaItems.splice(index, 1);
            renderRmaItems();
        }

        window.moveItemUp = function(index) {
            if (index > 0) {
                [rmaItems[index], rmaItems[index - 1]] = [rmaItems[index - 1], rmaItems[index]];
                renderRmaItems();
            }
        }

        window.moveItemDown = function(index) {
            if (index < rmaItems.length - 1) {
                [rmaItems[index], rmaItems[index + 1]] = [rmaItems[index + 1], rmaItems[index]];
                renderRmaItems();
            }
        }

        window.handleInputChange = function(index, field, value) {
            if (rmaItems[index]) {
                rmaItems[index][field] = value;
                updateOutput();
            }
        }

        // --- 渲染與輸出邏輯 (包含 C. 區塊) ---

        function renderRmaItems() {
            const container = document.getElementById('rmaListContainer');
            
            if (rmaItems.length === 0) {
                container.innerHTML = `<div class="p-6 text-center text-gray-500 italic">目前沒有 RMA 記錄，請點擊上方按鈕新增資料。</div>`;
                updateOutput();
                return;
            }
            
            let html = `
                <table class="w-full text-sm input-table">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="w-4">#</th>
                            <th>RMA No.</th>
                            <th>設備 ID</th>
                            <th>故障序號 (Def. SN)</th>
                            <th class="bg-red-100">換上序號 (Rep. SN)</th>
                            <th class="bg-red-100">貨運單號 (Tracking)</th>
                            <th class="bg-red-100">備註/描述</th>
                            <th class="w-16">操作</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            rmaItems.forEach((item, index) => {
                const placeholderNotes = item.productDesc || '手動輸入備註...';

                html += `
                    <tr class="hover:bg-gray-100 border-t border-gray-200">
                        <td class="text-center">${index + 1}</td>
                        <td>
                            <input type="text" value="${item.rmaNo}" oninput="handleInputChange(${index}, 'rmaNo', this.value)" placeholder="RMA No." />
                        </td>
                        <td>
                            <input type="text" value="${item.productID}" oninput="handleInputChange(${index}, 'productID', this.value)" placeholder="產品型號" />
                        </td>
                        <td>
                            <input type="text" value="${item.defectiveSn}" oninput="handleInputChange(${index}, 'defectiveSn', this.value)" placeholder="故障序號" />
                        </td>
                        <td>
                            <input type="text" value="${item.replacementSn}" oninput="handleInputChange(${index}, 'replacementSn', this.value)" placeholder="必填" class="bg-green-50" />
                        </td>
                        <td>
                            <input type="text" value="${item.trackingNumber}" oninput="handleInputChange(${index}, 'trackingNumber', this.value)" placeholder="必填" class="bg-blue-50" />
                        </td>
                        <td>
                            <input type="text" value="${item.notes}" oninput="handleInputChange(${index}, 'notes', this.value)" placeholder="${placeholderNotes}" />
                        </td>
                        <td class="text-center">
                            <div class="flex flex-col items-center space-y-1">
                                <!-- Move Up Button -->
                                <button onclick="moveItemUp(${index})" 
                                    class="text-gray-500 hover:text-indigo-700 p-1 rounded transition disabled:opacity-30" 
                                    ${index === 0 ? 'disabled' : ''} title="上移">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                                </button>
                                <!-- Move Down Button -->
                                <button onclick="moveItemDown(${index})" 
                                    class="text-gray-500 hover:text-indigo-700 p-1 rounded transition disabled:opacity-30" 
                                    ${index === rmaItems.length - 1 ? 'disabled' : ''} title="下移">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
                                </button>
                                <!-- Delete Button -->
                                <button onclick="deleteItem(${index})" class="text-red-500 hover:text-red-700 p-1 rounded transition" title="刪除">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3m-3 0h14"></path></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;
            container.innerHTML = html;
            updateOutput();
        }

        function updateOutput() {
            document.getElementById('itemCount').textContent = rmaItems.length;
            
            const { htmlTable, plaintextTable } = generateTables(rmaItems);
            const shippingForms = generateShippingForms(rmaItems);

            document.getElementById('htmlTableOutput').innerHTML = htmlTable;
            document.getElementById('plaintextTableOutput').textContent = plaintextTable;
            document.getElementById('shippingFormsOutput').innerHTML = shippingForms;
        }

        function generateTables(items) {
            if (items.length === 0) {
                const emptyMsg = '<p class="text-gray-500 italic">無 RMA 記錄可生成表格。</p>';
                return { htmlTable: emptyMsg, plaintextTable: '無 RMA 記錄可生成表格' };
            }

            let bodyHtml = '';
            const thStyle = "border: 1px solid #e5e7eb; padding: 10px 12px; text-align: left; background-color: #f3f4f6; font-weight: 600;";
            const tdStyle = "border: 1px solid #e5e7eb; padding: 10px 12px; text-align: left;";
            const tdSnStyle = "border: 1px solid #e5e7eb; padding: 10px 12px; text-align: left; font-weight: bold; color: #10B981;"; 
            const tdTrackStyle = "border: 1px solid #e5e7eb; padding: 10px 12px; text-align: left; font-weight: bold; color: #3B82F6;"; 

            items.forEach(item => {
                let displayNotes = item.notes.trim() || 'N/A';

                bodyHtml += `
                    <tr>
                        <td style="${tdStyle}">${item.rmaNo || 'N/A'}</td>
                        <td style="${tdStyle}">${item.productID || 'N/A'}</td>
                        <td style="${tdSnStyle}">${item.replacementSn || '【待確認】'}</td>
                        <td style="${tdStyle}">${item.defectiveSn || 'N/A'}</td>
                        <td style="${tdStyle}">${displayNotes}</td>
                        <td style="${tdTrackStyle}">${item.trackingNumber || '【待填寫】'}</td>
                    </tr>
                `;
            });

            const tableStyle = "width: 100%; border-collapse: collapse; font-size: 0.9rem; font-family: 'Inter', 'Microsoft JhengHei', sans-serif;";
            
            const htmlTable = `
                <table style="${tableStyle}">
                    <thead>
                        <tr>
                            <th style="${thStyle}">RMA</th>
                            <th style="${thStyle}">設備型號 (Product ID)</th>
                            <th style="${thStyle}">換上序號 (Replacement SN)</th>
                            <th style="${thStyle}">換下序號 (Defective SN)</th>
                            <th style="${thStyle}">備註 (Notes)</th>
                            <th style="${thStyle}">貨運單號 (Tracking)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${bodyHtml.trim()}
                    </tbody>
                </table>
            `;

            const plaintextHeader = [
                "RMA", "設備型號 (Product ID)", "換上序號 (Replacement SN)", 
                "換下序號 (Defective SN)", "備註 (Notes)", "貨運單號 (Tracking)"
            ];
            
            let plaintextOutput = plaintextHeader.join('\t') + '\n'; 

            items.forEach(item => {
                const displayNotes = item.notes.trim();
                
                const row = [
                    item.rmaNo || '',
                    item.productID || '',
                    item.replacementSn || '',
                    item.defectiveSn || '',
                    displayNotes,
                    item.trackingNumber || '',
                ];
                plaintextOutput += row.join('\t') + '\n';
            });
            
            return { htmlTable: htmlTable.trim(), plaintextTable: plaintextOutput.trim() };
        }
        
        // C. 寄件表格生成函數
        function generateShippingForms(items) {
            if (items.length === 0) {
                return '<p class="text-gray-500 italic">無 RMA 記錄可生成寄件表格。</p>';
            }

            let allFormsHtml = '';

            items.forEach((item, index) => {
                const itemHtml = `
                    <div class="shipping-form p-6 border border-gray-400 rounded-lg mb-8 bg-white shadow-lg" style="page-break-after: always; width: 100%; max-width: 800px; margin: 20px auto;">
                        <h4 class="text-xl font-bold mb-4 border-b pb-2 text-indigo-700">RMA 寄件明細 (${index + 1}/${items.length})</h4>
                        
                        <div class="space-y-3 text-lg">
                            <p><strong>RMA Number:</strong> <span class="text-red-600 font-extrabold">${item.rmaNo || '【待填寫】'}</span></p>
                            <p><strong>設備型號 (Product ID):</strong> <span>${item.productID || 'N/A'}</span></p>
                            <p><strong>故障序號 (Defective SN):</strong> <span>${item.defectiveSn || 'N/A'}</span></p>
                            <p><strong>換上序號 (Replacement SN):</strong> <span class="text-green-600 font-extrabold">${item.replacementSn || '【待填寫】'}</span></p>
                            <p><strong>貨運單號 (Tracking Number):</strong> <span class="text-blue-600 font-extrabold">${item.trackingNumber || '【待填寫】'}</span></p>
                            
                            <div class="pt-3 mt-3 border-t border-gray-200">
                                <p class="font-bold text-gray-700 mb-1">備註/問題描述 (Notes):</p>
                                <div class="p-3 bg-gray-50 border rounded-md whitespace-pre-wrap text-sm">${item.notes || '無'}</div>
                            </div>
                        </div>
                    </div>
                `;
                allFormsHtml += itemHtml;
            });

            return allFormsHtml;
        }
        
        // 列印所有寄件表格
        window.printShippingForms = function() {
            const content = document.getElementById('shippingFormsOutput').innerHTML;
            
            if (rmaItems.length === 0) {
                showCopyMessage('無 RMA 記錄可列印！', 'bg-red-600');
                return;
            }

            // 創建一個臨時視窗來包含內容並觸發列印
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>RMA 寄件表格列印</title>');
            
            // 引入列印專用樣式
            printWindow.document.write(`
                <style>
                    body { font-family: 'Inter', 'Microsoft JhengHei', sans-serif; margin: 0; padding: 0; background-color: white; }
                    /* 強制每一筆記錄列印在新的一頁 */
                    @media print {
                        .shipping-form { page-break-after: always; }
                    }
                    .shipping-form {
                        padding: 20px;
                        border: 1px solid #ccc;
                        margin: 20px auto;
                        width: 100%;
                        max-width: 800px;
                    }
                    .shipping-form h4 {
                        border-bottom: 2px solid #3b82f6;
                        padding-bottom: 8px;
                        margin-bottom: 15px;
                        font-size: 1.2rem;
                        color: #1f2937;
                    }
                    .shipping-form strong { font-weight: bold; }
                    .shipping-form span { font-weight: normal; }
                    .shipping-form .notes { white-space: pre-wrap; background: #f8f8f8; padding: 10px; border-radius: 4px; border: 1px solid #eee; }
                </style>
            `);
            
            printWindow.document.write('</head><body>');
            printWindow.document.write(content);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            
            // 等待內容載入後列印
            printWindow.onload = function() {
                printWindow.print();
                printWindow.close();
            }
            showCopyMessage('正在準備列印...', 'bg-yellow-600', 'printShippingBtn');
        }

        // 複製寄件表格 HTML 給 Word/Email
        window.copyShippingForms = function() {
            const outputElement = document.getElementById('shippingFormsOutput');
            
            if (rmaItems.length === 0) {
                showCopyMessage('無內容可複製！請新增 RMA 記錄。', 'bg-red-600');
                return;
            }
            
            // 複製完整的 HTML 內容，以便貼到 Word 或郵件客戶端
            fallbackCopy(outputElement.innerHTML, 'html', 'copyShippingBtn');
        }

        
        // --- 剪貼簿邏輯 (保持不變) ---

        function showCopyMessage(msg, bgColor, buttonId) {
            const copiedMsg = document.getElementById('copiedMsg');
            copiedMsg.textContent = msg;
            copiedMsg.className = `copied-message fixed bottom-4 right-4 ${bgColor} text-white px-5 py-3 rounded-xl shadow-2xl show`;

            if (buttonId) {
                const button = document.getElementById(buttonId);
                const originalHtml = button.innerHTML;
                button.innerHTML = '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> 已複製';
                
                setTimeout(() => {
                    button.innerHTML = originalHtml;
                }, 2000);
            }

            setTimeout(() => {
                copiedMsg.classList.remove('show');
                copiedMsg.className = `copied-message fixed bottom-4 right-4 bg-gray-800 text-white px-5 py-3 rounded-xl shadow-2xl`; 
            }, 2000);
        }

        window.copyTableContent = function(type) {
            const outputElement = type === 'html' ? 
                document.getElementById('htmlTableOutput').querySelector('table') :
                document.getElementById('plaintextTableOutput');
            
            const buttonId = type === 'html' ? 'copyHtmlBtn' : 'copyPlaintextBtn';

            if (rmaItems.length === 0) {
                showCopyMessage('無內容可複製！請新增 RMA 記錄。', 'bg-red-600');
                return;
            }

            const contentToCopy = type === 'html' ? outputElement.outerHTML : outputElement.textContent;

            fallbackCopy(contentToCopy, type, buttonId);
        }
        
        function fallbackCopy(content, type, buttonId) {
            let tempEl;
            
            if (type === 'html') {
                tempEl = document.createElement('div');
                tempEl.innerHTML = content;
                document.body.appendChild(tempEl);

                const selection = window.getSelection();
                const range = document.createRange();
                range.selectNodeContents(tempEl);
                selection.removeAllRanges();
                selection.addRange(range);
                
            } else {
                tempEl = document.createElement('textarea');
                tempEl.value = content;
                document.body.appendChild(tempEl);
                tempEl.select();
            }
            
            tempEl.style.position = 'absolute';
            tempEl.style.left = '-9999px';

            try {
                const successful = document.execCommand('copy');

                if (type === 'html') {
                    window.getSelection().removeAllRanges();
                }

                if (successful) {
                    showCopyMessage(`${type === 'html' ? 'HTML 表格' : '純文字表格'}已成功複製！`, 'bg-blue-600', buttonId);
                } else {
                    showCopyMessage('複製失敗，請手動選取複製。', 'bg-red-600');
                }
            } catch (err) {
                console.error('Copy failed (fallback):', err);
                showCopyMessage('複製失敗，請手動選取複製。', 'bg-red-600');
            }
            document.body.removeChild(tempEl);
        }

        // 頁面載入時執行一次初始化
        window.onload = function() {
            renderRmaItems(); 
        }
    </script>
</body>
</html>
